name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate-versions:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Validate version sync
      run: |
        CORE_VERSION=$(python -c "import re; print(re.search(r'__version__ = \"([^\"]+)\"', open('packages/deepfreeze-core/deepfreeze_core/__init__.py').read()).group(1))")
        CLI_VERSION=$(python -c "import re; print(re.search(r'__version__ = \"([^\"]+)\"', open('packages/deepfreeze-cli/deepfreeze/__init__.py').read()).group(1))")
        TAG_VERSION=${GITHUB_REF#refs/tags/v}

        echo "Core version: $CORE_VERSION"
        echo "CLI version: $CLI_VERSION"
        echo "Tag version: $TAG_VERSION"

        if [ "$CORE_VERSION" != "$CLI_VERSION" ]; then
          echo "ERROR: Version mismatch between packages!"
          echo "  deepfreeze-core: $CORE_VERSION"
          echo "  deepfreeze-cli: $CLI_VERSION"
          exit 1
        fi

        if [ "$CORE_VERSION" != "$TAG_VERSION" ]; then
          echo "ERROR: Version doesn't match git tag!"
          echo "  Code version: $CORE_VERSION"
          echo "  Tag version: $TAG_VERSION"
          exit 1
        fi

        echo "All versions match: $CORE_VERSION"

  release:
    needs: validate-versions
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
